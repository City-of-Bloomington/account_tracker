<template>
  <div class="body-cover">
    <form class="login-wrapper">
      <svg version="1.1" id="city-of-bloomington-logo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="150px" height="150px" viewBox="0 0 150 150" enable-background="new 0 0 150 150" xml:space="preserve">
        <polygon fill="#1e5aae" points="31.9991798,21.9479866 22.7739067,12.826499 22.7739067,22.8042793 12.8196859,22.8042793
          21.3657379,32.579998 12.8196859,41.1248817 41.1218987,41.1248817 41.1218987,12.826499 "/>
        <polygon fill="#1e5aae" points="21.9450626,117.9943542 12.823596,127.2196503 22.8013535,127.2196503 22.8013535,137.1738892
          32.5770493,128.6278229 41.1219177,137.1738892 41.1219177,108.8716202 12.823596,108.8716202 "/>
        <polygon fill="#1e5aae" points="128.0453339,32.0021477 137.1667938,22.7768517 127.1890411,22.7768517 127.1890411,12.822608
          117.4133453,21.368679 108.8684769,12.822608 108.8684769,41.1248817 137.1667938,41.1248817 "/>
        <polygon fill="#1e5aae" points="117.9912109,128.0485077 127.2164841,137.1699982 127.2164841,127.1922226 137.1707001,127.1922226
          128.624649,117.4165039 137.1707001,108.8716202 108.8684998,108.8716202 108.8684998,137.1699982 "/>
        <polygon fill="#1e5aae" points="56.9043694,60.8636856 42.7692757,46.7080574 14.4699984,46.7080574 28.3536053,61.0300636
          0,61.0300636 14.4675837,75.0031052 0,89.594017 28.3536053,89.594017 14.4675837,103.2866516 42.7739372,103.2884445
          56.9035759,89.1315002 42.7724113,74.9960251 "/>
        <polygon fill="#1e5aae" points="93.0956268,89.1328201 107.2307281,103.2884445 135.5299988,103.2884445 121.6463928,88.9664383
          150,88.9664383 135.5324097,74.9934006 150,60.4024849 121.6463928,60.4024849 135.5324097,46.7098541 107.226059,46.7080574
          93.0964203,60.8650055 107.2275925,75.0004807 "/>
        <polygon fill="#1e5aae" points="89.1297226,56.9044991 103.2853165,42.7693748 103.2853165,14.4700317 88.9633408,28.3536701
          88.9633408,0 74.9903336,14.467617 60.399456,0 60.399456,28.3536701 46.7068558,14.467617 46.7050591,42.7740364
          60.8619728,56.9037056 74.9974136,42.7725067 "/>
        <polygon fill="#1e5aae" points="60.860672,93.0954971 46.7050781,107.230629 46.7050781,135.5299683 61.02705,121.6463318
          61.02705,150 75.000061,135.5323792 89.5909348,150 89.5909348,121.6463318 103.2835388,135.5323792 103.2853394,107.2259674
          89.128418,93.0962906 74.9929733,107.2274933 "/>
      </svg>

      <p v-if="errorMessge">{{errorMessge}}</p>
      {{isAuthenticated}}
      <fn1-input v-model="username"
               label="Username"
               placeholder="Username"
               name="username"
               id="username" />

      <div class="field-group">
        <label for="password">Password</label>
        <input v-model="password"
               placeholder="Password"
               id="password"
               type="password"
               name="password">
      </div>

      <fn1-button @click.native="postLogin">login</fn1-button>
    </form>
  </div>
</template>

<script>
import axios        from 'axios'
import {
  mapFields }       from 'vuex-map-fields';

const Cookie = process.client ? require('js-cookie') : undefined

export default {
  middleware: 'notAuthenticated',
  data () {
    return {
      errorMessge:  '',
      username:     '',
      password:     ''
    }
  },
  computed: {
    ...mapFields(['endpoints','isAuthenticated'])
  },
  methods: {
    postLogin() {
      const payload = {
        username: this.username,
        password: this.password
      }
      axios.post(`${this.endpoints.baseUrl}${this.endpoints.obtainJWT}`, payload)
      .then((response) => {
        console.log(response);
        this.$store.commit('SET_AUTH', response.data.token)
        Cookie.set('auth', response.data.token)

        this.$axios.get(`${this.endpoints.baseUrl}user/`)
        .then((response) => {
          console.log(response.data)
          this.$store.commit("SET_AUTH_USER", response.data)
          this.$store.commit("SET_IS_AUTHENTICATED", true)
          this.$router.push('/')
        })
      })
      .catch((error) => {
        this.errorMessge = error.response.data;
        console.log(error);
        console.debug(error);
        console.dir(error);
      })
    }
  }
}
</script>

<style lang="scss" scoped>
@import '@/assets/style.scss';
  .body-cover {
    background-color: $color-blue;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  .login-wrapper {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    margin: 0 auto;
    background-color: lighten($text-color, 60%);
    width: 300px;
    padding: 30px;
    border-radius: $radius-default;

    svg {
      display: block;
      margin: 0 auto 20px auto;
      width: 100px;
      height: 100px;
    }

    p {
      background-color: $text-color;
      color: white;
      text-align: center;
      border-radius: $radius-default;
      padding: 10px 20px;
      margin-bottom: 20px;
    }

    button {
      background-color: $color-green;
      width: 100%;
      padding: 10px 0;
      margin: 0;
    }
  }
</style>